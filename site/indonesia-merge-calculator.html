<!DOCTYPE html>
<html lang="en">
<head>
<title>Indonesia Merger Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Merger Calc">

<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
/*
  * { outline: 1px solid red; }
*/
  /* Base layout */
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 16px;
  color: #333;
  transition: background-color 0.25s ease, color 0.25s ease;
}

.container {
  max-width: 600px;
  margin: 0 auto;
}

.hidden,
.row.hidden {
  display: none;
}

h1 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 1.8rem;
}

.section {
  background: white;
  padding: 18px;
  margin-bottom: 18px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: background-color 0.25s ease, color 0.25s ease;
}

.section h2 {
  margin-top: 0;
  border-bottom: 1px solid #ddd;
  padding-bottom: 6px;
  font-size: 1.3rem;
}

.fields-2 {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

@media (max-width: 400px) {
  .fields-2 {
    gap: 4px;
  }
}

.fields-2.fields-2--narrow-right {
  grid-template-columns: 6fr 4fr;
}

.row {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  margin-bottom: 14px;
}

.row label,
.row .field-label,
.row .label-with-icon {
  font-weight: bold;
  margin-bottom: 6px;
}

.row .label-tail {
  white-space: nowrap;
}

input[type="text"],
input[type="number"],
select,
.dropdown,
.calc-output {
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1.1rem;
  width: 100%;
  box-sizing: border-box;
  transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
}

input[readonly],
.calc-output {
  background: #eee;
}

.dropdown:focus-visible {
  outline: 2px solid;
  outline-offset: 2px;
}

/* Stepper buttons */
.stepper {
  display: flex;
  align-items: center;
  gap: 10px;
}

.stepper button {
  width: 40px;
  height: 40px;
  border: 1px solid #aaa;
  background: #eee;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1.4rem;
  line-height: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: background-color 0.25s ease, border-color 0.25s ease;
}

.stepper button {
  touch-action: manipulation; /* reduces 300ms delay on some browsers */
}

/* disable text selection */
.stepper button {
  -webkit-user-select: none; /* Safari / Chrome on mobile */
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;

  -webkit-touch-callout: none; /* prevents iOS long-press menu */
}

.stepper button:active {
  background: #ddd;
}

.stepper input {
  width: 80px;
  font-size: 1.2rem;
  text-align: center;
}

@media (max-width: 400px) {
  .stepper input {
    width: 42px;
  }
}

/* disable number input's spin buttons */
/* Chrome, Safari, Edge, Opera */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  appearance: textfield;
  -moz-appearance: textfield; /* Firefox */
}

/*-------------------------------------*/

.tooltip {
  position: relative;
}

.radio-group label .tooltiptext {
  font-weight: normal;
}

.tooltiptext {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-bottom: 8px;

  background: #f5f7fa;
  color: #1a1a1a;
  border: 1px solid #c7d0dd;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  padding: 8px 10px;
  width: max-content;
  max-width: 260px;
  font-weight: normal;
  font-size: 0.9rem;
  line-height: 1.3;
  text-align: left;
  border-radius: 4px;
  white-space: normal;
  opacity: 0;
  transition: opacity .15s ease-out;
  pointer-events: none;
}

.tooltip-right .tooltiptext {
  left: 0;
  transform: translateX(0);
}

.tooltip:hover .tooltiptext {
  opacity: 1;
}

body.dark .tooltip .tooltiptext {
  background-color: #222;
  color: #eee;
}

.tooltiptext {
  max-width: 90vw;
  width: max-content;      /* grows to fit text */
}

@media (max-width: 600px) {
  .tooltiptext {
    width: calc(100vw - 10rem);
    max-width: calc(100vw - 2rem);
  }
}

/*-------------------------------------*/

/* Dark mode toggle button */
.theme-toggle {
  position: fixed;
  top: 12px;
  right: 12px;
  padding: 10px 14px;
  font-size: 1rem;
  border: none;
  border-radius: 8px;
  background: #ddd;
  cursor: pointer;
  z-index: 1000;
  transition: background-color 0.25s ease, color 0.25s ease;
}

.theme-toggle:active {
  background: #ccc;
}

/* DARK MODE */
body.dark {
  background: #1e1e1e;
  color: #e5e5e5;
}

body.dark .section {
  background: #2a2a2a;
  box-shadow: 0 2px 6px rgba(0,0,0,0.6);
}

body.dark input,
body.dark select,
body.dark .calc-output {
  background: #3a3a3a;
  color: #fff;
  border-color: #555;
}

body.dark input[readonly],
body.dark .calc-output {
  background: #444;
}

body.dark .stepper button {
  background: #444;
  border-color: #666;
  color: #eee;
}

body.dark .stepper button:active {
  background: #555;
}

body.dark .theme-toggle {
  background: #444;
  color: #eee;
}

/* RADIO GROUP (Company Type) */
.radio-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.radio-group label {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: #f0f0f0;
  border-radius: 8px;
  font-size: 1.1rem;
  cursor: pointer;
  white-space: nowrap;
  border: 2px solid transparent;
  transition: background-color 0.25s ease, border-color 0.25s ease, color 0.25s ease;
}

.radio-group .radio-text {
  position: relative;
  top: 1px;
}

.radio-group input[type="radio"] {
  transform: scale(1.3);
}

/* Highlight selected option */
.radio-group label:has(input[type="radio"]:checked) {
  background: #d0e8ff;
  border-color: #4a90e2;
  font-weight: bold;
}

/* Dark mode highlight */
body.dark .radio-group label {
  background: #333;
  color: #eee;
}

body.dark .radio-group label:has(input[type="radio"]:checked) {
  background: #2f4a66;
  border-color: #6bb6ff;
  color: #fff;
}

/* Base warning icon style */
.warn {
  color: #444;
}

/* Dark mode version */
body.dark .warn {
  color: #999;
}

/*---------------------------------------------------------*/

.dropdown {
  position: relative;
  width: 100%;
  border: 1px solid #aaa;
  border-radius: 6px;
  background: var(--bg, #fff);
  cursor: pointer;
  user-select: none;
  outline: none;
}

.dropdown-selected {
  padding: 8px 12px;
}

/*---*/
.dropdown-selected {
  display: flex;
  flex-direction: column;
  gap: 2px; /* optional */
}

.dropdown-selected strong {
  font-weight: bold;
}

.breakdown {
  font-family: monospace;
}

.dropdown-selected .breakdown {
  font-size: 0.9rem;
  opacity: 0.8;
}
/*---*/

.dropdown-options {
  display: none;
  position: absolute;
  left: 0;
  right: 0;
  background: var(--bg, #fff);
  border: 1px solid #aaa;
  border-radius: 6px;
  max-height: 340px;
  overflow-y: auto;
  z-index: 20;
}

.dropdown.open .dropdown-options {
  display: block;
}

.dropdown-option {
  padding: 8px 12px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.dropdown-option.hover,
.dropdown-option:hover {
  background: rgba(0,0,0,0.08);
}

.dropdown-option.selected {
  background: rgba(0,0,0,0.15);
  font-weight: 600;
}

.dropdown-option strong {
  font-weight: 700;
}

.dropdown-option .breakdown {
  opacity: 0.6;
  font-size: 0.85em;
}

/* Dark mode */
body.dark .dropdown {
  --bg: #222;
  color: #eee;
  border-color: #555;
}

body.dark .dropdown-options {
  background: #222;
  border-color: #555;
}

body.dark .dropdown-option.hover,
body.dark .dropdown-option:hover {
  background: rgba(255,255,255,0.08);
}

body.dark .dropdown-option.selected {
  background: rgba(255,255,255,0.15);
}

/* MIN badge */
.badge-min {
  display: inline-block;
  margin-left: 2px;
  padding: 2px 6px;
  font-size: 0.7rem;
  font-weight: 700;
  border-radius: 4px;
  letter-spacing: 0.5px;

  background: rgba(0,0,0,0.08);
  color: #444;
}

/* Dark mode tweak */
body.dark .badge-min {
  background: rgba(255,255,255,0.12);
  color: #ddd;
}

/* ------------------- */

.calc-output {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 5px;
  width: 100%;
  min-width: 0; /* allow flex container to shrink */
}

.calc-output .breakdown {
  font-family: monospace;
  font-size: 0.9rem;
  opacity: 0.75;
  min-width: 0; /* allow shrinking */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: clip;
}

.calc-output .value {
  font-weight: 400;
  flex-shrink: 0; /* value must always stay visible */
}

/* Allow grid children to shrink */
.fields-2 > * {
  min-width: 0;
}

/* ------------------- */

.footer {
  text-align: center;
  margin-top: 28px;
  font-size: 0.8rem;
  opacity: 0.6;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
}

.github-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: #000;          /* light mode black */
  text-decoration: none;
}

.github-link:hover {
  color: #222;          /* brighten slightly on hover */
}

body.dark .github-link {
  color: #aaa;          /* soft grey for dark mode */
}

body.dark .github-link:hover {
  color: #fff;          /* brighten slightly on hover */
}

body.dark .footer {
  opacity: 0.5;
}

.icon {
  display: inline-flex;
  align-items: center;
  vertical-align: middle;
}

.icon svg {
  display: block;
}

.icon-warning {
  transform: translateY(-1px);
}

.icon-info {
  transform: translateY(-1px);
}
</style>

<script type="text/javascript">

const APP_VERSION = "0.9.1";
const COMMIT_HASH = "__COMMIT_HASH__";

document.addEventListener("DOMContentLoaded", () => {
  const versionEl = document.getElementById("versionInfo");

  let commit = "";

  if (COMMIT_HASH !== "__COMMIT_HASH__") {
    commit = COMMIT_HASH;
  }
  if (commit === "") {
    // Try to detect commit hash from URL (GitHub Pages style)
    const params = new URLSearchParams(window.location.search);
    if (params.has("commit")) {
      commit = params.get("commit");
    }
  }
  const maxCommitLength = 15;
  if (commit.length >= maxCommitLength) commit = commit.substring(0, maxCommitLength);

  if (commit) {
    versionEl.textContent = `v${APP_VERSION} · ${commit}`;
  } else {
    versionEl.textContent = `v${APP_VERSION}`;
  }
});

document.addEventListener("DOMContentLoaded", function () {
  const body = document.body;
  const btn = document.getElementById("themeToggle");

  // Check saved preference
  const savedTheme = localStorage.getItem("theme");

  if (savedTheme) {
    // Apply the inverse of saved theme - because we toggle it
    body.classList.toggle("dark", savedTheme !== "dark");
  } else {
    // No saved preference → follow system theme
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    body.classList.toggle("dark", !prefersDark);
  }

  themeToggle();
});

function themeToggle() {
  const body = document.body;
  const btn = document.getElementById("themeToggle");

  body.classList.toggle("dark");

  const isDark = body.classList.contains("dark");

  // Update button
  setIcon(btn, isDark ? "icon-sun" : "icon-moon");

  // Save preference
  localStorage.setItem("theme", isDark ? "dark" : "light");
}

function setIcon(element, iconId) {
  element.innerHTML = `
    <span class="icon" aria-hidden="true">
      <svg width="18" height="18">
        <use href="#${iconId}"></use>
      </svg>
    </span>
  `;
}

/* dropdown */
function createDropdown(dropdownEl, onSelect) {
  const selected = dropdownEl.querySelector(".dropdown-selected");
  const optionsContainer = dropdownEl.querySelector(".dropdown-options");

  let options = [];
  let hoverIndex = -1;
  let currentValue = null;

  function updateHover() {
    options.forEach((opt, i) => {
      opt.classList.toggle("hover", i === hoverIndex);
    });

    if (hoverIndex >= 0) {
      options[hoverIndex].scrollIntoView({ block: "nearest" });
    }
  }

  function selectOption(opt, { shouldClose }) {
    currentValue = opt.dataset.value;   // ← store bidPerGood here
    selected.innerHTML = opt.innerHTML;

    options.forEach(o => o.classList.remove("selected"));
    opt.classList.add("selected");

    if (shouldClose) {
      close();
    }

    onSelect(currentValue);
  }

  function addDropdownOption(labelHTML, value) {
    const opt = document.createElement("div");
    opt.className = "dropdown-option";
    opt.dataset.value = value;          // ← store bidPerGood
    opt.innerHTML = labelHTML;

    opt.addEventListener("click", () => selectOption(opt, { shouldClose: false })); // don't close here, the dropdownEl.click does it for us

    optionsContainer.appendChild(opt);
    options.push(opt);
  }

  // Open/close
  function open() {
    dropdownEl.classList.add("open");
    dropdownEl.setAttribute("aria-expanded", "true");

    // Set hoverIndex to the selected option
    const selectedIndex = options.findIndex(o => o.classList.contains("selected"));
    hoverIndex = selectedIndex >= 0 ? selectedIndex : 0;

    updateHover();
  }

  function close() {
    dropdownEl.classList.remove("open");
    dropdownEl.setAttribute("aria-expanded", "false");
  }

  dropdownEl.addEventListener("click", () => {
    dropdownEl.classList.contains("open") ? close() : open();
  });

  // Close on outside click
  document.addEventListener("click", e => {
    if (!dropdownEl.contains(e.target)) close();
  });

  // Keyboard navigation
  document.addEventListener("keydown", e => {
    const isOpen = dropdownEl.classList.contains("open");

    // --- CLOSED DROPDOWN BEHAVIOR ---
    if (!isOpen) {
      // Only react if this dropdown has focus
      if (document.activeElement !== dropdownEl) return;

      if (e.key === "Enter") {
        // Enter opens the dropdown
        open();
        e.preventDefault();
        return;
      }

      if (e.key === "ArrowDown") {
        // Move selection down without opening
        e.preventDefault();
        let idx = options.findIndex(o => o.classList.contains("selected"));
        idx = Math.min(idx + 1, options.length - 1);
        selectOption(options[idx], { shouldClose: true });
        return;
      }

      if (e.key === "ArrowUp") {
        // Move selection up without opening
        e.preventDefault();
        let idx = options.findIndex(o => o.classList.contains("selected"));
        idx = Math.max(idx - 1, 0);
        selectOption(options[idx], { shouldClose: true });
        return;
      }

      return; // done with closed behavior
    }

    // --- OPEN DROPDOWN BEHAVIOR ---
    if (e.key === "ArrowDown") {
      e.preventDefault();
      hoverIndex = Math.min(hoverIndex + 1, options.length - 1);
      updateHover();
    }

    if (e.key === "ArrowUp") {
      e.preventDefault();
      hoverIndex = Math.max(hoverIndex - 1, 0);
      updateHover();
    }

    if (e.key === "Enter") {
      e.preventDefault();
      if (hoverIndex >= 0) {
        selectOption(options[hoverIndex], { shouldClose: true });
      }
    }

    if (e.key === "Escape") {
      close();
    }
  });

  dropdownEl.addEventListener("keydown", e => {
    if (e.key === "Tab" && !e.shiftKey) {
      close();
      return;
    }
    else if (e.key === "Tab" && e.shiftKey) {
      e.preventDefault(); // stop dropdown from interfering

      // Close the dropdown if it's open
      close();

      // Move focus to the previous focusable element
      const focusables = Array.from(
        document.querySelectorAll(
          'a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])'
        )
      ).filter(el => !el.disabled && el.offsetParent !== null && el.id !== "HiddenBidListInput");

      const index = focusables.indexOf(dropdownEl);

      if (index > 0) {
        focusables[index - 1].focus();
      }

      return;
    }
  });

  function clear() {
    optionsContainer.innerHTML = "";
    options = [];
    hoverIndex = -1;
    currentValue = null;
    selected.innerHTML = "Choose a bid…";
  }

  // Public API
  return {
    addDropdownOption,
    clear,
    getValue: () => currentValue,
    selectOption: (idx) => selectOption(options[idx], { shouldClose: true })
  };
}

document.addEventListener("DOMContentLoaded", () => {
  const list = document.getElementById("BidList");
  list.dropdown = createDropdown(list, value => onBidChanged(value));

  document.getElementById("HiddenBidListInput").addEventListener("focus", () => {
    document.getElementById("BidList").focus();
  });
});

/* ------ */

/* ------ */

document.addEventListener("DOMContentLoaded", () => { initSteppers(); });

function initSteppers() {
  document.querySelectorAll(".stepper button").forEach(button => {
    const delta = Number(button.dataset.step);

    let holdTimer;
    let repeatTimer;

    const input = button.closest(".stepper").querySelector("input");

    const stepInput = (input, delta) => {
      const min = Number(input.min);
      const max = Number(input.max);
      const step = Number(input.step || 1);

      let value = Number(input.value) + delta * step;

      if (!isNaN(min)) value = Math.max(value, min);
      if (!isNaN(max)) value = Math.min(value, max);

      input.value = value;
      input.dispatchEvent(new Event("change"));
    }

    const start = e => {
      e.preventDefault();

      // Immediate single step
      stepInput(input, delta);

      // Start long-press detection
      holdTimer = setTimeout(() => {
        repeatTimer = setInterval(() => {
          stepInput(input, delta * 5);
        }, 120);
      }, 400);
    };

    const stop = () => {
      clearTimeout(holdTimer);
      clearInterval(repeatTimer);
    };

    button.addEventListener("pointerdown", start);
    button.addEventListener("pointerup", stop);
    button.addEventListener("pointerleave", stop);
    button.addEventListener("pointercancel", stop);
  });
}

/* -------------------------------- */

window.addEventListener("resize", () => {
  document.querySelectorAll(".calc-output")
    .forEach(updateBreakdownVisibility);
});

const observer = new MutationObserver((mutations) => {
  for (const mutation of mutations) {
    const breakdown = mutation.target;
    const container = breakdown.closest(".calc-output");
    updateBreakdownVisibility(container);
  }
});

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".breakdown").forEach(breakdown => {
    observer.observe(breakdown, {
      childList: true,
      characterData: true,
      subtree: true
    });
  });
});

function updateBreakdownVisibility(container) {
  const breakdown = container.querySelector(".breakdown");
  if (!breakdown) return;

  // Reset in case it was hidden before
  breakdown.style.display = "";

  // Force layout check
  if (breakdown.scrollWidth > breakdown.clientWidth) {
    breakdown.style.display = "none";
  }
}

/* -------------------------------- */

function getGoodValue(coType) {
  if (coType === 99) return 25;
  return coType;
}

function getGoodPrice(coType) {
  if (coType === 99) return 35;
  return coType;
}

function calculateProjectedIncome() {
  // Read inputs
  const totalGoods = parseInt(document.getElementById("ShippedGoods").value) || 0;
  const shipFees = parseInt(document.getElementById("ShipFees").value) || 0;
  const years = parseInt(document.getElementById("Years").value) || 1;
  const coType = parseInt(document.querySelector('input[name="CoTyp"]:checked').value);

  // Get outputs
  const revenueValue = document.getElementById("revenue-value")
  const revenueBreakdown = document.getElementById("revenue-breakdown")
  const costsValue = document.getElementById("costs-value")
  const costsBreakdown = document.getElementById("costs-breakdown")
  const netValue = document.getElementById("net-value")
  const netBreakdown = document.getElementById("net-breakdown")
  const futureValue = document.getElementById("FutureValue-value")
  const futureBreakdown = document.getElementById("FutureValue-breakdown")

  let PI = 0;

  let revenue = 0;
  let costs = 0;

  // --- Shipping Company ---
  if (coType === 10) {
    revenue = shipFees * 5;
    costs = 0;

    revenueValue.innerText = "0";
    revenueBreakdown.innerText = "";

    costsValue.innerText = "0";
    costsBreakdown.innerHTML = "";

    netValue.innerText = revenue;
    netBreakdown.innerHTML = `= ${shipFees} &times; 5`;
  }
  // --- Production Companies ---
  else {
    // assuming in Rice/Spice → Siap Saji case the totalGoods is already halved
    const goodPrice = getGoodPrice(coType);
    revenue = totalGoods * goodPrice;
    revenueValue.innerText = revenue;
    revenueBreakdown.innerHTML = `= ${totalGoods} &times; ${goodPrice}`

    costs = shipFees * 5;
    costsValue.innerText = costs;
    costsBreakdown.innerHTML = `= ${shipFees} &times; 5`;

    netValue.innerText = revenue - costs;
    netBreakdown.innerHTML = `= ${revenue} &minus; ${costs}`;
  }

  PI = (revenue - costs) * years;
  futureValue.innerText = PI;
  futureBreakdown.innerHTML = `= ${years} &times; ${revenue - costs}`;
}

function buildBiddingSection() {
  const coType = parseInt(document.querySelector('input[name="CoTyp"]:checked').value);
  const goods1 = parseInt(document.getElementById("NGood1").value) || 0;
  const goods2 = parseInt(document.getElementById("NGood2").value) || 0;

  const totalGoods = goods1 + goods2;
  const goodValue = getGoodValue(coType);

  const bidList = document.getElementById("BidList").dropdown;
  bidList.clear();

  for (let i = 0; i < 300; i++) {
    const bidPerGood = goodValue + i;
    const total = bidPerGood * totalGoods;

    const minBadge = i === 0
      ? `<span class="badge-min">MIN</span>`
      : "";

    const label = `
      <div style="display:flex; align-items:center; gap:6px;">
        <strong>${total}</strong>
        ${minBadge}
      </div>
      <span class="breakdown">
        = ${bidPerGood} &times; (${goods1} + ${goods2})
        = ${bidPerGood * goods1} + ${bidPerGood * goods2}
      </span>
    `;

    bidList.addDropdownOption(label, bidPerGood);
  }
  bidList.selectOption(0);

  calculateCompanyValues();
}

function calculateCompanyValues() {
  const bidN = document.getElementById("BidList").dropdown.getValue();
  const coType = parseInt(document.querySelector('input[name="CoTyp"]:checked').value);
  const goodValue = getGoodValue(coType);

  const goods1 = parseInt(document.getElementById("NGood1").value) || 0;
  const goods2 = parseInt(document.getElementById("NGood2").value) || 0;

  const val1value = document.getElementById("CoVal1-value");
  const val1breakdown = document.getElementById("CoVal1-breakdown");
  const val2value = document.getElementById("CoVal2-value");
  const val2breakdown = document.getElementById("CoVal2-breakdown");

  val1value.innerText = bidN * goods1;
  val1breakdown.innerHTML = `= ${bidN} &times; ${goods1}`;
  val2value.innerText = bidN * goods2;
  val2breakdown.innerHTML = `= ${bidN} &times; ${goods2}`;
}

function calculateProjectedIncomeParameters() {
  const coType = parseInt(document.querySelector('input[name="CoTyp"]:checked').value);
  const goods1 = parseInt(document.getElementById("NGood1").value) || 0;
  const goods2 = parseInt(document.getElementById("NGood2").value) || 0;

  const shippedGoods = document.getElementById("ShippedGoods");
  const shippedAmount = (coType === 99) ? Math.floor((goods1 + goods2) / 2) : goods1 + goods2;
  shippedGoods.value = shippedAmount;

  const shipFees = document.getElementById("ShipFees");
  shipFees.value = Math.floor(shippedAmount * 1.5);

  // show/hide shippingGoodsRow and shippingCostsField
  const shippingGoodsRow = document.getElementById("shippingGoodsRow");
  const shippingCostsField = document.getElementById("shippingCostsField");
  if (coType === 10) {
    shippingGoodsRow.classList.add("hidden");
    shippingCostsField.classList.add("hidden");
  } else {
    shippingGoodsRow.classList.remove("hidden");
    shippingCostsField.classList.remove("hidden");
  }
}

function onFutureParametersChanged() {
  calculateProjectedIncome();
}

function onBaseParametersChanged() {
  buildBiddingSection();
  calculateCompanyValues();
  calculateProjectedIncomeParameters();
  calculateProjectedIncome();
}

function onBidChanged(){
  calculateCompanyValues();
}

function init(){
  onBaseParametersChanged();
}

document.addEventListener("DOMContentLoaded", () => { init(); });
</script>
</head>

<body>

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  
  <!-- Info icon -->
  <symbol id="icon-info" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
    <line x1="12" y1="10" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <circle cx="12" cy="7" r="1.2" fill="currentColor"/>
  </symbol>

  <!-- Warning icon -->
  <symbol id="icon-warning" viewBox="0 0 24 24">
    <path d="M12 3 L21 20 H3 Z" stroke="currentColor" stroke-width="2" fill="none" stroke-linejoin="round"/>
    <line x1="12" y1="9" x2="12" y2="14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <circle cx="12" cy="17" r="1.2" fill="currentColor"/>
  </symbol>

  <!-- Sun icon -->
  <symbol id="icon-sun" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="5.8" stroke="currentColor" stroke-width="2" fill="none"/>
    <line x1="12" y1="2" x2="12" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="12" y1="18" x2="12" y2="22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="2" y1="12" x2="6" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="18" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="4.5" y1="4.5" x2="7.5" y2="7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="16.5" y1="16.5" x2="19.5" y2="19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="4.5" y1="19.5" x2="7.5" y2="16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="16.5" y1="7.5" x2="19.5" y2="4.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </symbol>

  <!-- Moon icon -->
  <symbol id="icon-moon" viewBox="0 0 24 24">
    <path d="M21 12.5A9 9 0 1 1 11.5 3 7 7 0 0 0 21 12.5Z"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          stroke-linejoin="round"/>
  </symbol>

</svg>

<div class="container">
<h1>Indonesia Merger Calculator</h1>

<button id="themeToggle" class="theme-toggle" onclick="themeToggle()">
  <span class="icon" aria-hidden="true">
    <svg width="18" height="18">
      <use href="#icon-moon"></use>
    </svg>
  </span>
</button>

<form name="top">

<!-- Company Type  -->
<div class="section">
  <h2>Company Type</h2>
  <div class="radio-group">
    <label>
      <input type="radio" name="CoTyp" value="10" checked onclick="onBaseParametersChanged()">
      <span class="radio-text">Shipping</span>
    </label>

    <label>
      <input type="radio" name="CoTyp" value="20" onclick="onBaseParametersChanged()">
      <span class="radio-text">Rice</span>
    </label>

    <label>
      <input type="radio" name="CoTyp" value="25" onclick="onBaseParametersChanged()">
      <span class="radio-text">Spice</span>
    </label>

    <label>
      <input type="radio" name="CoTyp" value="30" onclick="onBaseParametersChanged()">
      <span class="radio-text">Rubber</span>
    </label>

    <label>
      <input type="radio" name="CoTyp" value="35" onclick="onBaseParametersChanged()">
      <span class="radio-text">Siap Saji</span>
    </label>

    <label>
      <input type="radio" name="CoTyp" value="40" onclick="onBaseParametersChanged()">
      <span class="radio-text">Oil</span>
    </label>

    <label class="tooltip">
      <input type="radio" name="CoTyp" value="99" onclick="onBaseParametersChanged()">
      <span class="radio-text">Rice/Spice → Siap Saji
        <span class="warn">
          <span class="icon icon-warning">
            <svg width="16" height="16">
              <use href="#icon-warning"></use>
            </svg>
          </span>
        </span>
        <span class="tooltiptext">
          A siap saji company <strong>cannot be formed in era A</strong>; only in era B or C
        </span>
      </span>
    </label>
  </div>
</div>

<!-- Number of Goods -->
<div class="section">
  <h2>Number of Goods</h2>

  <div class="row">
    <label for="NGood1">Company 1:</label>
    <div class="stepper">
      <button type="button" data-step="-1">&minus;</button>
      <input type="number" id="NGood1" value="2" min="1" max="20" onchange="onBaseParametersChanged()">
      <button type="button" data-step="1">&plus;</button>
    </div>
  </div>

  <div class="row">
    <label for="NGood2">Company 2:</label>
    <div class="stepper">
      <button type="button" data-step="-1">&minus;</button>
      <input type="number" id="NGood2" value="3" min="1" max="20" onchange="onBaseParametersChanged()">
      <button type="button" data-step="1">&plus;</button>
    </div>
  </div>
</div>

<!-- Bidding -->
<div class="section">
  <h2>Bidding</h2>

  <div class="row">
    <label for="HiddenBidListInput">Bid:</label>
    <input id="HiddenBidListInput"
       type="text"
       style="position:absolute; opacity:0; pointer-events:none; height:0; width:0;">
    <div id="BidList"
        class="dropdown"
        tabindex="0"
        role="combobox"
        aria-haspopup="listbox"
        aria-expanded="false"
        aria-controls="BidList-options"
        aria-labelledby="BidLabel"
        >
      <div class="dropdown-selected">Choose a bid…</div>
      <div class="dropdown-options" id="BidList-options" role="listbox"></div>
    </div>
  </div>

  <div class="row">
    <label for="CoVal1">Company 1 Share:</label>
    <output class="calc-output" id="CoVal1">
      <strong class="value" id="CoVal1-value">30</strong>
      <span class="breakdown" id="CoVal1-breakdown">3 &times; 10</span>
    </output>
  </div>

  <div class="row">
    <label for="CoVal2">Company 2 Share:</label>
    <output class="calc-output" id="CoVal2">
      <strong class="value" id="CoVal2-value">30</strong>
      <span class="breakdown" id="CoVal2-breakdown">3 &times; 10</span>
    </output>
  </div>
</div>

<!-- Future Value -->
<div class="section">
  <h2>Future Value</h2>

  <div id="shippingGoodsRow" class="hidden">
    <div class="fields-2 fields-2--narrow-right">
      <!-- Shipped Goods -->
      <div class="row">
        <span class="label-with-icon" id="ShippedGoods-label">
          Shipped Goods per <span class="label-tail">Year:
          <span class="tooltip">
            <span class="icon icon-info" aria-hidden="true">
              <svg width="16" height="16">
                <use href="#icon-info"></use>
              </svg>
            </span>
            <span class="tooltiptext">
              <u>Shipping Companies:</u><br>
              This value does not affect the income.<br><br>

              <u>Rice/Spice → Siap Saji:</u><br>
              Halve the produced goods (round down) before entering this value.
            </span>
          </span>
          </span>
        </span>
        <div class="stepper">
          <button type="button" data-step="-1">&minus;</button>
          <input type="number" id="ShippedGoods" value="2" min="0" max="50" onchange="onFutureParametersChanged()" aria-labelledby="ShippedGoods-label">
          <button type="button" data-step="1">&plus;</button>
        </div>
      </div>

      <!-- Revenue -->
      <div class="row">
        <label for="revenue">Revenue:</label>
        <output class="calc-output" id="revenue">
          <strong class="value" id="revenue-value">0</strong>
          <span class="breakdown" id="revenue-breakdown"></span>
        </output>
      </div>
    </div>
  </div>

  <div class="fields-2 fields-2--narrow-right">
    <!-- Shipping Fees -->
    <div class="row">
      <span class="label-with-icon" id="ShipFees-label">
      Ship Fees per <span class="label-tail">Year:
        <span class="tooltip">
          <span class="icon icon-info" aria-hidden="true">
            <svg width="16" height="16">
              <use href="#icon-info"></use>
            </svg>
          </span>
          <span class="tooltiptext">
            Shipping Cost per Year = Ship Fees &times; 5.
          </span>
        </span>
        </span>
      </span>
      <div class="stepper">
        <button type="button" data-step="-1">&minus;</button>
        <input type="number" id="ShipFees" value="2" min="0" max="50" onchange="onFutureParametersChanged()" aria-labelledby="ShipFees-label">
        <button type="button" data-step="1">&plus;</button>
      </div>
    </div>

    <!-- Shipping Cost -->
    <div id="shippingCostsField" class="hidden row">
      <label for="costs">Costs:</label>
      <output class="calc-output" id="costs">
        <strong class="value" id="costs-value">10</strong>
        <span class="breakdown" id="costs-breakdown">2 &times; 5</span>
      </output>
    </div>
  </div>

  <div class="fields-2 fields-2--narrow-right">
    <!-- Years -->
    <div class="row">
      <span class="label-with-icon" id="Years-label">
        Years of <span class="label-tail">Operation:
        <span class="tooltip">
          <span class="icon icon-info" aria-hidden="true">
            <svg width="16" height="16">
              <use href="#icon-info"></use>
            </svg>
          </span>
          <span class="tooltiptext">
            How many years the merged company is expected to operate.
          </span>
        </span>
        </span>
      </span>
      <div class="stepper">
        <button type="button" data-step="-1">&minus;</button>
        <input type="number" id="Years" value="1" min="1" max="50" onchange="onFutureParametersChanged()" aria-labelledby="Years-label">
        <button type="button" data-step="1">&plus;</button>
      </div>
    </div>

    <!-- Net Per Year -->
    <div class="row">
      <label for="net">Net Income:</label>
      <output class="calc-output" id="net">
        <strong class="value" id="net-value">10</strong>
        <span class="breakdown" id="net-breakdown">10 &minus; 0</span>
      </output>
    </div>
  </div>

  <!-- Potential Income -->
  <div class="row">
    <span class="label-with-icon" id="FutureValue-label">
    Potential <span class="label-tail">Income:
      <span class="tooltip">
        <span class="icon icon-info" aria-hidden="true">
          <svg width="16" height="16">
            <use href="#icon-info"></use>
          </svg>
        </span>
        <span class="tooltiptext">
          Potential Income (PI) is the future value of the merged company, assuming it doesn't grow.<br><br>

          <u>Shipping Companies:</u><br>
          PI = Ship Fees &times; 5 &times; Years<br><br>

          <u>Production Companies:</u><br>
          PI = (Shipped Goods &times; Good Price &minus; Ship Fees &times; 5) &times; Years<br>
          For <u>Rice/Spice → Siap Saji</u>, Good Price = 35.
        </span>
      </span>
      </span>
    </span>
    <output class="calc-output" id="FutureValue" aria-labelledby="FutureValue-label">
      <strong class="value" id="FutureValue-value">10</strong>
      <span class="breakdown" id="FutureValue-breakdown">1 &times; (10 &minus; 0)</span>
    </output>
  </div>
</div>

</form>

  <div class="footer">
    <a href="https://github.com/TimurKelman/indonesia-merge-calculator"
      target="_blank"
      rel="noopener"
      class="github-link"
      aria-label="View source on GitHub">
      
      <!-- GitHub SVG icon -->
      <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
        <path d="M12 .5C5.65.5.5 5.65.5 12c0 5.1 3.29 9.42 7.86 10.95.58.1.79-.25.79-.56v-2.05
        c-3.2.7-3.87-1.54-3.87-1.54-.52-1.3-1.27-1.64-1.27-1.64-1.04-.7.08-.69.08-.69
        1.15.08 1.75 1.18 1.75 1.18 1.02 1.75 2.67 1.24 3.32.95.1-.74.4-1.24.73-1.53
        -2.55-.29-5.23-1.27-5.23-5.64 0-1.24.44-2.25 1.17-3.05-.12-.29-.51-1.45.11-3.02
        0 0 .95-.3 3.1 1.16.9-.25 1.86-.37 2.82-.37s1.92.12 2.82.37c2.15-1.46 3.1-1.16
        3.1-1.16.62 1.57.23 2.73.11 3.02.73.8 1.17 1.81 1.17 3.05 0 4.38-2.69 5.34-5.25
        5.63.41.35.77 1.04.77 2.1v3.12c0 .31.21.67.8.56C20.21 21.42 23.5 17.1 23.5 12
        23.5 5.65 18.35.5 12 .5z"/>
      </svg>

      <span id="versionInfo"></span>
    </a>
  </div>

</div>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>
</body>
</html>
